<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AliveAgain - –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è</title>
    <link rel="stylesheet" href="auth-styles.css">
</head>
<body>
    <div class="auth-container">
        <div class="auth-card">
            <div class="auth-header">
                <h1 class="auth-logo">AliveAgain</h1>
                <p class="auth-tagline">–ü—É—Ç–µ—à–µ—Å—Ç–≤—É–π –ø–æ –º–∏—Ä—É –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ</p>
            </div>

            <!-- –§–û–†–ú–ê –í–•–û–î–ê -->
            <div id="login-form" class="auth-form active">
                <h2>–í—Ö–æ–¥ –≤ —Å–∏—Å—Ç–µ–º—É</h2>
                
                <form id="login-input">
                    <div class="form-group">
                        <label for="login-email">Email</label>
                        <input 
                            type="email" 
                            id="login-email" 
                            placeholder="your@email.com"
                            required
                        >
                    </div>

                    <div class="form-group">
                        <label for="login-password">–ü–∞—Ä–æ–ª—å</label>
                        <input 
                            type="password" 
                            id="login-password" 
                            placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                            required
                        >
                    </div>

                    <button type="submit" class="btn btn-primary">–í–æ–π—Ç–∏</button>
                </form>

                <div class="form-footer">
                    <p>–ù–µ—Ç –∞–∫–∫–∞—É–Ω—Ç–∞? 
                        <a href="#" class="toggle-form" data-form="register">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</a>
                    </p>
                </div>

                <div id="login-error" class="error-message"></div>
                <div id="login-success" class="success-message"></div>
            </div>

            <!-- –§–û–†–ú–ê –†–ï–ì–ò–°–¢–†–ê–¶–ò–ò -->
            <div id="register-form" class="auth-form">
                <h2>–°–æ–∑–¥–∞—Ç—å –∞–∫–∫–∞—É–Ω—Ç</h2>
                
                <form id="register-input">
                    <div class="form-group">
                        <label for="register-username">–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</label>
                        <input 
                            type="text" 
                            id="register-username" 
                            placeholder="–í–∞—à–µ –∏–º—è"
                            required
                        >
                    </div>

                    <div class="form-group">
                        <label for="register-email">Email</label>
                        <input 
                            type="email" 
                            id="register-email" 
                            placeholder="your@email.com"
                            required
                        >
                    </div>

                    <div class="form-group">
                        <label for="register-password">–ü–∞—Ä–æ–ª—å</label>
                        <input 
                            type="password" 
                            id="register-password" 
                            placeholder="–ú–∏–Ω–∏–º—É–º 8 —Å–∏–º–≤–æ–ª–æ–≤"
                            minlength="8"
                            required
                        >
                    </div>

                    <div class="form-group">
                        <label for="register-password-confirm">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å</label>
                        <input 
                            type="password" 
                            id="register-password-confirm" 
                            placeholder="–ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –ø–∞—Ä–æ–ª—å"
                            minlength="8"
                            required
                        >
                    </div>

                    <div class="form-group">
                        <label for="register-country">–°—Ç—Ä–∞–Ω–∞ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</label>
                        <input 
                            type="text" 
                            id="register-country" 
                            placeholder="–í–∞—à–∞ —Å—Ç—Ä–∞–Ω–∞"
                        >
                    </div>

                    <button type="submit" class="btn btn-primary">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</button>
                </form>

                <div class="form-footer">
                    <p>–£–∂–µ –µ—Å—Ç—å –∞–∫–∫–∞—É–Ω—Ç? 
                        <a href="#" class="toggle-form" data-form="login">–í–æ–π—Ç–∏</a>
                    </p>
                </div>

                <div id="register-error" class="error-message"></div>
                <div id="register-success" class="success-message"></div>
            </div>
        </div>

        <!-- –ò–ù–§–û–†–ú–ê–¶–ò–Ø –û –ü–†–û–ï–ö–¢–ï -->
        <div class="auth-info">
            <div class="info-item">
                <span class="info-icon">üåç</span>
                <h3>–í–∏—Ä—Ç—É–∞–ª—å–Ω—ã–µ –ø—É—Ç–µ—à–µ—Å—Ç–≤–∏—è</h3>
                <p>–ü–æ—Å–µ—â–∞–π –ª—é–±—ã–µ —Å—Ç—Ä–∞–Ω—ã –º–∏—Ä–∞ –±–µ–∑ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π</p>
            </div>
            <div class="info-item">
                <span class="info-icon">üë•</span>
                <h3>–°–æ—Ü–∏–∞–ª—å–Ω–∞—è —Å–µ—Ç—å</h3>
                <p>–û–±—â–∞–π—Å—è —Å –¥—Ä—É–∑—å—è–º–∏ —Å–æ –≤—Å–µ–≥–æ –º–∏—Ä–∞</p>
            </div>
            <div class="info-item">
                <span class="info-icon">ü•Ω</span>
                <h3>VR –û–ø—ã—Ç</h3>
                <p>–ü–æ–ª–Ω–∞—è –∏–º–º–µ—Ä—Å–∏—è –≤ –≤–∏—Ä—Ç—É–∞–ª—å–Ω—É—é —Ä–µ–∞–ª—å–Ω–æ—Å—Ç—å</p>
            </div>
        </div>
    </div>

    <script type="module">
        import { 
            signUp, 
            signIn,
            getCurrentUser
        } from './supabase-client.js'

        console.log('‚úÖ –°–∫—Ä–∏–ø—Ç –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –∑–∞–≥—Ä—É–∂–µ–Ω')

        // ============================================
        // –ü–ï–†–ï–ö–õ–Æ–ß–ï–ù–ò–ï –ú–ï–ñ–î–£ –§–û–†–ú–ê–ú–ò
        // ============================================
        document.querySelectorAll('.toggle-form').forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault()
                const formName = e.target.dataset.form
                console.log('–ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –Ω–∞ —Ñ–æ—Ä–º—É:', formName)
                
                // –°–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ —Ñ–æ—Ä–º—ã
                document.querySelectorAll('.auth-form').forEach(form => {
                    form.classList.remove('active')
                })
                
                // –û—á–∏—â–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–∞—Ö
                document.querySelectorAll('.error-message, .success-message').forEach(msg => {
                    msg.textContent = ''
                })
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –Ω—É–∂–Ω—É—é —Ñ–æ—Ä–º—É
                document.getElementById(`${formName}-form`).classList.add('active')
            })
        })

        // ============================================
        // –§–û–†–ú–ê –í–•–û–î–ê
        // ============================================
        const loginForm = document.getElementById('login-input')
        if (loginForm) {
            loginForm.addEventListener('submit', async (e) => {
                e.preventDefault()
                
                const email = document.getElementById('login-email').value.trim()
                const password = document.getElementById('login-password').value
                const errorDiv = document.getElementById('login-error')
                const successDiv = document.getElementById('login-success')
                
                // –í–∞–ª–∏–¥–∞—Ü–∏—è
                if (!email || !password) {
                    errorDiv.innerHTML = '‚ùå –ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è'
                    return
                }
                
                // –û—á–∏—â–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è
                errorDiv.textContent = ''
                successDiv.textContent = ''
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
                const button = e.target.querySelector('button')
                const originalText = button.textContent
                button.textContent = '‚è≥ –í—Ö–æ–¥...'
                button.disabled = true
                
                try {
                    console.log('üîê –ü–æ–ø—ã—Ç–∫–∞ –≤—Ö–æ–¥–∞:', email)
                    const result = await signIn(email, password)
                    
                    if (result.success) {
                        console.log('‚úÖ –í—Ö–æ–¥ —É—Å–ø–µ—à–µ–Ω!')
                        successDiv.innerHTML = '‚úÖ –í—Ö–æ–¥ —É—Å–ø–µ—à–µ–Ω! –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ...'
                        
                        // –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ –≥–ª–∞–≤–Ω—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É —á–µ—Ä–µ–∑ 2 —Å–µ–∫—É–Ω–¥—ã
                        setTimeout(() => {
                            window.location.href = 'index.html'
                        }, 2000)
                    } else {
                        throw new Error(result.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞')
                    }
                } catch (error) {
                    console.error('‚ùå –û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞:', error)
                    let errorMessage = error.message
                    
                    if (errorMessage.includes('Invalid login credentials')) {
                        errorMessage = '–ù–µ–≤–µ—Ä–Ω—ã–π email –∏–ª–∏ –ø–∞—Ä–æ–ª—å'
                    } else if (errorMessage.includes('Email not confirmed')) {
                        errorMessage = '–ü—Ä–æ–≤–µ—Ä—å—Ç–µ email –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è'
                    }
                    
                    errorDiv.innerHTML = `‚ùå ${errorMessage}`
                } finally {
                    button.textContent = originalText
                    button.disabled = false
                }
            })
        }

        // ============================================
        // –§–û–†–ú–ê –†–ï–ì–ò–°–¢–†–ê–¶–ò–ò
        // ============================================
        const registerForm = document.getElementById('register-input')
        if (registerForm) {
            registerForm.addEventListener('submit', async (e) => {
                e.preventDefault()
                
                const username = document.getElementById('register-username').value.trim()
                const email = document.getElementById('register-email').value.trim()
                const password = document.getElementById('register-password').value
                const passwordConfirm = document.getElementById('register-password-confirm').value
                const country = document.getElementById('register-country').value.trim()
                const errorDiv = document.getElementById('register-error')
                const successDiv = document.getElementById('register-success')
                
                console.log('üìù –ù–∞—á–∞–ª–æ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏')
                
                // –û—á–∏—â–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è
                errorDiv.textContent = ''
                successDiv.textContent = ''
                
                // –í–∞–ª–∏–¥–∞—Ü–∏—è –≤—Å–µ—Ö –ø–æ–ª–µ–π
                if (!username || !email || !password || !passwordConfirm) {
                    errorDiv.innerHTML = '‚ùå –ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è'
                    console.warn('–ù–µ –∑–∞–ø–æ–ª–Ω–µ–Ω—ã –≤—Å–µ –ø–æ–ª—è')
                    return
                }
                
                if (username.length < 3) {
                    errorDiv.innerHTML = '‚ùå –ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –º–∏–Ω–∏–º—É–º 3 —Å–∏–º–≤–æ–ª–∞'
                    console.warn('–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–æ–µ:', username.length)
                    return
                }
                
                if (!email.includes('@')) {
                    errorDiv.innerHTML = '‚ùå –í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π email'
                    console.warn('Email –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π')
                    return
                }
                
                if (password.length < 8) {
                    errorDiv.innerHTML = '‚ùå –ü–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –º–∏–Ω–∏–º—É–º 8 —Å–∏–º–≤–æ–ª–æ–≤'
                    console.warn('–ü–∞—Ä–æ–ª—å —Å–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–∏–π:', password.length)
                    return
                }
                
                if (password !== passwordConfirm) {
                    errorDiv.innerHTML = '‚ùå –ü–∞—Ä–æ–ª–∏ –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç'
                    console.warn('–ü–∞—Ä–æ–ª–∏ –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç')
                    return
                }
                
                console.log('‚úÖ –í–∞–ª–∏–¥–∞—Ü–∏—è –ø—Ä–æ–π–¥–µ–Ω–∞. –û—Ç–ø—Ä–∞–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö...')
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
                const button = e.target.querySelector('button')
                const originalText = button.textContent
                button.textContent = '‚è≥ –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è...'
                button.disabled = true
                
                try {
                    console.log('üìù –ü–æ–ø—ã—Ç–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏:', { username, email })
                    const result = await signUp(email, password, username)
                    
                    console.log('–†–µ–∑—É–ª—å—Ç–∞—Ç —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏:', result)
                    
                    if (result.success) {
                        console.log('‚úÖ –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞!')
                        successDiv.innerHTML = `‚úÖ –ê–∫–∫–∞—É–Ω—Ç —Å–æ–∑–¥–∞–Ω! –ü—Ä–æ–≤–µ—Ä—å—Ç–µ email –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è.`
                        
                        // –û—á–∏—â–∞–µ–º —Ñ–æ—Ä–º—É
                        registerForm.reset()
                        
                        // –ü–µ—Ä–µ—Ö–æ–¥–∏–º –Ω–∞ —Ñ–æ—Ä–º—É –≤—Ö–æ–¥–∞ —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã
                        setTimeout(() => {
                            document.getElementById('register-form').classList.remove('active')
                            document.getElementById('login-form').classList.add('active')
                            document.getElementById('login-email').focus()
                        }, 3000)
                    } else {
                        throw new Error(result.error || '–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏')
                    }
                } catch (error) {
                    console.error('‚ùå –û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏:', error)
                    let errorMessage = error.message
                    
                    // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã—Ö –æ—à–∏–±–æ–∫
                    if (errorMessage.includes('already registered') || errorMessage.includes('User already exists')) {
                        errorMessage = '–≠—Ç–æ—Ç email —É–∂–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω'
                    } else if (errorMessage.includes('invalid email')) {
                        errorMessage = '–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç email'
                    } else if (errorMessage.includes('weak password')) {
                        errorMessage = '–°–ª–∞–±—ã–π –ø–∞—Ä–æ–ª—å. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –±—É–∫–≤—ã –∏ —Ü–∏—Ñ—Ä—ã'
                    } else if (errorMessage.includes('password should be')) {
                        errorMessage = '–ü–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –º–∏–Ω–∏–º—É–º 8 —Å–∏–º–≤–æ–ª–æ–≤'
                    }
                    
                    errorDiv.innerHTML = `‚ùå ${errorMessage}`
                } finally {
                    button.textContent = originalText
                    button.disabled = false
                }
            })
        }

        // ============================================
        // –ü–†–û–í–ï–†–ö–ê –ê–í–¢–û–†–ò–ó–û–í–ê–ù–ù–û–ì–û –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø
        // ============================================
        async function checkAuth() {
            try {
                console.log('üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏...')
                const { data: { user }, error } = await getCurrentUser()
                
                if (user && !error) {
                    console.log('‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω:', user.email)
                    // –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω, –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ –≥–ª–∞–≤–Ω—É—é
                    window.location.href = 'index.html'
                } else {
                    console.log('‚ÑπÔ∏è –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω')
                }
            } catch (err) {
                console.log('‚úÖ –§–æ—Ä–º–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –≥–æ—Ç–æ–≤–∞ (–æ—à–∏–±–∫–∞ –Ω–æ—Ä–º–∞–ª—å–Ω–∞ –¥–ª—è –Ω–µ–∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è)')
            }
        }

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã —Å –Ω–µ–±–æ–ª—å—à–æ–π –∑–∞–¥–µ—Ä–∂–∫–æ–π
        setTimeout(checkAuth, 500)

        // –¢–∞–∫–∂–µ –ø—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ä–∞–∑—É
        window.addEventListener('load', () => {
            console.log('üì¶ –°—Ç—Ä–∞–Ω–∏—Ü–∞ –ø–æ–ª–Ω–æ—Å—Ç—å—é –∑–∞–≥—Ä—É–∂–µ–Ω–∞')
        })
    </script>
</body>
</html>
